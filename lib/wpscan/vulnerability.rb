require 'wpscan/vulnerable'

module WPScan
  # Specific implementation
  class Vulnerability < CMSScanner::Vulnerability
    # @return [ Array<String> ]
    def references_urls
      wpvulndb_urls + super
    end

    # @return [ Array<String> ]
    def wpvulndb_ids
      @wpvulndb_ids ||= [*references[:wpvulndb]].map(&:to_s)
    end

    # @return [ Array<String> ]
    def wpvulndb_urls
      wpvulndb_ids.reduce([]) { |a, e| a << wpvulndb_url(e) }
    end

    # @return [ String ]
    def wpvulndb_url(id)
      "https://wpvulndb.com/vulnerabilities/#{id}"
    end

    # @param [ Hash ] json_data
    # @return [ Vulnerability ]
    def self.load_from_json(json_data)
      references = {}

      [:cve, :url, :secunia, :osvdb, :exploitdb, :metasploit, :packetstrom].each do |key|
        references[key] = json_data[key.to_s] if json_data.key?(key.to_s)
      end

      references[:wpvulndb] = json_data['id'].to_s

      new(
        json_data['title'],
        references,
        json_data['vuln_type'],
        json_data['fixed_in']
      )
    end
  end
end
